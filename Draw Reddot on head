local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Biến toggle
_G.dotESPEnabled = not _G.dotESPEnabled -- bật/tắt mỗi lần chạy
local enabled = _G.dotESPEnabled

-- Biến lưu dấu chấm và kết nối
_G.dotESPConnections = _G.dotESPConnections or {}
_G.dotESPObjects = _G.dotESPObjects or {}

if not enabled then
	-- Nếu tắt -> xóa toàn bộ dấu chấm và ngưng kết nối
	for _, dot in pairs(_G.dotESPObjects) do
		dot:Remove()
	end
	_G.dotESPObjects = {}

	for _, connection in pairs(_G.dotESPConnections) do
		connection:Disconnect()
	end
	_G.dotESPConnections = {}
	return
end

-- Tạo dấu chấm
local function createDot(player)
	if player == localPlayer then return end

	local dot = Drawing.new("Circle")
	dot.Radius = 5
	dot.Color = Color3.fromRGB(255, 0, 0)
	dot.Filled = true
	dot.Transparency = 1
	dot.Visible = false

	_G.dotESPObjects[player] = dot
end

-- Xoá dấu chấm khi người chơi rời
local function removeDot(player)
	if _G.dotESPObjects[player] then
		_G.dotESPObjects[player]:Remove()
		_G.dotESPObjects[player] = nil
	end
end

-- Tạo dấu chấm cho tất cả người chơi hiện tại
for _, player in pairs(Players:GetPlayers()) do
	createDot(player)
end

-- Kết nối sự kiện thêm người chơi
table.insert(_G.dotESPConnections, Players.PlayerAdded:Connect(function(player)
	createDot(player)
end))

-- Kết nối sự kiện xoá người chơi
table.insert(_G.dotESPConnections, Players.PlayerRemoving:Connect(removeDot))

-- Cập nhật vị trí mỗi frame
table.insert(_G.dotESPConnections, RunService.RenderStepped:Connect(function()
	for player, dot in pairs(_G.dotESPObjects) do
		local character = player.Character
		if character and character:FindFirstChild("Head") then
			local headPos = character.Head.Position
			local screenPos, onScreen = camera:WorldToViewportPoint(headPos)
			if onScreen then
				dot.Position = Vector2.new(screenPos.X, screenPos.Y)
				dot.Visible = true
			else
				dot.Visible = false
			end
		else
			dot.Visible = false
		end
	end
end))
