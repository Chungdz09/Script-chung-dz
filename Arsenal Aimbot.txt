local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- Config
local lockRange = 2000
local rotationSpeed = 1
local fovAngle = 16
local visualFovRadius = 100
local toggleKey = Enum.KeyCode.F

local localPlayer = Players.LocalPlayer
local camera = workspace.CurrentCamera
local lockedPlayer = nil
local lockingOn = false
local lockEnabled = true -- mặc định bật

local fovCircle = nil

local function createFOVCircle()
    if fovCircle then return end
    fovCircle = Drawing.new("Circle")
    fovCircle.Color = Color3.fromRGB(255, 0, 0)
    fovCircle.Thickness = 2
    fovCircle.Radius = visualFovRadius
    fovCircle.Filled = false
    fovCircle.Transparency = 1
    fovCircle.Visible = true
end

local function removeFOVCircle()
    if fovCircle then
        fovCircle:Remove()
        fovCircle = nil
    end
end

local function findNearestPlayerInFOV()
    if not localPlayer.Character or not localPlayer.Character:FindFirstChild("Head") then
        return nil
    end

    local localPos = localPlayer.Character.Head.Position
    local camLook = camera.CFrame.LookVector

    local nearest = nil
    local shortestDistance = lockRange

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
            -- Loại trừ đồng đội
            if player.Team == localPlayer.Team then
                -- Bỏ qua đồng đội
            else
                local targetPos = player.Character.Head.Position
                local distance = (targetPos - localPos).Magnitude

                if distance < shortestDistance then
                    local dirToTarget = (targetPos - localPos).Unit
                    local dot = math.clamp(camLook:Dot(dirToTarget), -1, 1)
                    local angle = math.deg(math.acos(dot))

                    if angle < fovAngle then
                        shortestDistance = distance
                        nearest = player
                    end
                end
            end
        end
    end

    return nearest
end

local function lockOn()
    lockedPlayer = findNearestPlayerInFOV()
    if lockedPlayer then
        lockingOn = true
        print("Locked on:", lockedPlayer.Name)
    else
        print("No target in range or FOV.")
    end
end

local function releaseLock()
    lockingOn = false
    lockedPlayer = nil
end

local function toggleLock()
    lockEnabled = not lockEnabled
    print("Lock enabled:", lockEnabled)
    if lockEnabled then
        createFOVCircle()
    else
        releaseLock()
        removeFOVCircle()
    end
end

-- Khởi tạo FOV Circle lần đầu
createFOVCircle()

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == toggleKey then
        toggleLock()
    elseif input.UserInputType == Enum.UserInputType.MouseButton2 then
        if lockEnabled then
            lockOn()
        end
    end
end)

UserInputService.InputEnded:Connect(function(input, gp)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        releaseLock()
    end
end)

RunService:BindToRenderStep("LockOnSystem", Enum.RenderPriority.Camera.Value + 1, function()
    if lockEnabled and fovCircle then
        local mousePos = UserInputService:GetMouseLocation()
        fovCircle.Position = Vector2.new(mousePos.X, mousePos.Y)
    end

    if lockEnabled and lockingOn and lockedPlayer and lockedPlayer.Character and lockedPlayer.Character:FindFirstChild("Head") then
        local targetPos = lockedPlayer.Character.Head.Position
        local direction = (targetPos - camera.CFrame.Position).Unit
        local targetCFrame = CFrame.new(camera.CFrame.Position, camera.CFrame.Position + direction)
        camera.CFrame = camera.CFrame:Lerp(targetCFrame, rotationSpeed)
    end
end)

pcall(function()
    game.StarterGui:SetCore("SendNotification", {
        Title = "Auto Lock-On",
        Text = "Loaded. Press F to toggle.",
        Duration = 4,
    })
end)
